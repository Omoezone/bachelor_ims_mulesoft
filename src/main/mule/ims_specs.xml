<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:java="http://www.mulesoft.org/schema/mule/java" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd  http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
    <http:listener-config name="ims_specs-httpListenerConfig">
        <http:listener-connection host="${api.host}" port="${http.port}" />
    </http:listener-config>
    <apikit:config name="ims_specs-config" api="resource::a1600366-34e7-452e-a23d-daddabc1e9c9:ims_specs:1.0.24:raml:zip:ims_specs.raml" outboundHeadersMapName="outboundHeaders" httpStatusVarName="httpStatus" />
    <flow name="ims_specs-main">
        <http:listener config-ref="ims_specs-httpListenerConfig" path="/api/*">
            <http:response statusCode="#[vars.httpStatus default 200]">
                <http:headers>#[vars.outboundHeaders default {}]</http:headers>
            </http:response>
            <http:error-response statusCode="#[vars.httpStatus default 500]">
                <http:body>#[payload]</http:body>
                <http:headers>#[vars.outboundHeaders default {}]</http:headers>
            </http:error-response>
        </http:listener>
        <apikit:router config-ref="ims_specs-config" />
        <error-handler>
            <on-error-propagate type="APIKIT:BAD_REQUEST">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Bad request"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">400</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_FOUND">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Resource not found"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">404</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
            <on-error-propagate type="APIKIT:METHOD_NOT_ALLOWED">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Method not allowed"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">405</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_ACCEPTABLE">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not acceptable"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">406</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
            <on-error-propagate type="APIKIT:UNSUPPORTED_MEDIA_TYPE">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Unsupported media type"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">415</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
            <on-error-propagate type="APIKIT:NOT_IMPLEMENTED">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not Implemented"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">501</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
        </error-handler>
    </flow>
    <flow name="ims_specs-console">
        <http:listener config-ref="ims_specs-httpListenerConfig" path="/console/*">
            <http:response statusCode="#[vars.httpStatus default 200]">
                <http:headers>#[vars.outboundHeaders default {}]</http:headers>
            </http:response>
            <http:error-response statusCode="#[vars.httpStatus default 500]">
                <http:body>#[payload]</http:body>
                <http:headers>#[vars.outboundHeaders default {}]</http:headers>
            </http:error-response>
        </http:listener>
        <apikit:console config-ref="ims_specs-config" />
        <error-handler>
            <on-error-propagate type="APIKIT:NOT_FOUND">
                <ee:transform doc:name="Transform Message">
                    <ee:message>
                        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Resource not found"}]]></ee:set-payload>
                    </ee:message>
                    <ee:variables>
                        <ee:set-variable variableName="httpStatus">404</ee:set-variable>
                    </ee:variables>
                </ee:transform>
            </on-error-propagate>
        </error-handler>
    </flow>
    <flow name="get:\users:ims_specs-config">
        <db:select doc:name="Select" doc:id="826e227e-77bf-44e1-8b91-db77e63efbf7" config-ref="Database_Config">
            <db:sql><![CDATA[SELECT * FROM ims.users]]></db:sql>
        </db:select>
        <ee:transform doc:name="Transform Message" doc:id="e9d80ee4-be20-430d-bf9f-9897d980d085">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	userId: payload01.user_id as Number,
	firstName: payload01.first_name,
	lastName: payload01.last_name,
	email: payload01.email,
	password: payload01.password,
	(age: payload01.age as Number) if (payload01.age != null),
	gender: payload01.gender
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <logger level="INFO" doc:name="Log select query response" doc:id="c754b5ce-7328-43c8-815f-be7d2ac41348" message="#[payload]" />
    </flow>
    <flow name="get:\users\(userId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="5cb33924-5692-4d9e-87f3-b178c290944b" variableName="getOneUser" />
        <try doc:name="Try" doc:id="41ecfad8-6e4d-463e-9e9a-3c2cf53773d7">
            <db:query-single doc:name="Query single" doc:id="c37b68b7-15db-4b54-921a-c1e2ddf2701b" config-ref="Database_Config">
                <db:sql><![CDATA[SELECT 	
u.user_id, u.first_name, u.last_name, u.email, u.password, u.age, u.gender
FROM users u
WHERE u.user_id = :ID]]></db:sql>
                <db:input-parameters><![CDATA[#[{ID: vars.getOneUser}]]]></db:input-parameters>
            </db:query-single>
            <ee:transform doc:name="Transform Message" doc:id="cf87f228-f3a1-40c3-b398-ff8bbcd15f3e">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	userId: payload.user_id as Number,
	firstName: payload.first_name,
	lastName: payload.last_name,
	email: payload.email,
	password: payload.password,
	(age: payload.age as Number) if (payload.age != null),
	gender: payload.gender
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </try>
        <remove-variable doc:name="Remove Variable" doc:id="4ce7b910-5af8-4194-956a-f37ac49c1d80" variableName="getOneUser" />
        <logger level="INFO" doc:name="Logger" doc:id="3d4ce615-30ce-4c89-b026-f80f36858203" message="#[payload]" />
    </flow>
    <flow name="post:\users:application\json:ims_specs-config">
        <java:invoke-static doc:name="Invoke static" doc:id="7efd98ca-09eb-4503-88c6-40b93badd31b" class="security.PasswordHasher" method="hashPassword(java.lang.String)" target="hashedPassword">
            <java:args><![CDATA[#[arg0: payload.password]]]></java:args>
        </java:invoke-static>
        <ee:transform doc:name="Transform Message" doc:id="c2ae685a-9f83-44ae-a40b-fe144372d144">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  firstName: payload.firstName,
  lastName: payload.lastName,
  email: payload.email,
  password: vars.hashedPassword,
  age: payload.age as Number,
  gender: payload.gender default null
} as Object {encoding: "UTF-8", mediaType: "application/json"}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <try doc:name="Try" doc:id="af31639c-152a-446e-bb0d-5a8912eee2bf">
            <db:stored-procedure doc:name="Stored procedure" doc:id="5d4a687f-4b45-467c-b248-1bc532ef610f" config-ref="Database_Config">
                <db:sql><![CDATA[CALL RegisterAndDefaultGroup(
:FIRSTNAME, :LASTNAME, :EMAIL, :PASSWORD, :AGE, :GENDER
)]]></db:sql>
                <db:input-parameters><![CDATA[#[{
	FIRSTNAME: payload.firstName,
	LASTNAME: payload.lastName,
	EMAIL: payload.email, 
	PASSWORD: vars.hashedPassword,
	AGE: payload.age,
	GENDER: payload.gender
}]]]></db:input-parameters>
            </db:stored-procedure>
            <ee:transform doc:name="Transform Message" doc:id="00f54f62-3a3f-4103-b1c9-79ae19bfc661">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	message: "Successfully created new user"
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </try>
        <remove-variable doc:name="Remove Variable" doc:id="b586a76a-239f-4897-b69f-219e0b5d098a" variableName="hashedPassword" />
        <logger level="INFO" doc:name="Logger" doc:id="d8557ba6-5fb8-499b-aa6b-95d63ffda46e" message="Successfully created user" />
    </flow>
    <flow name="put:\users\(userId):application\json:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="20eb8295-7ce8-4bfa-92bb-4ce883df46d0" variableName="updateUserId" />
        <ee:transform doc:name="Transform Message1" doc:id="8b3fa88a-4596-4157-9b9a-98a7c1e99806">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
    firstName: payload.firstName,
    lastName: payload.lastName,
    email: payload.email,
    password: payload.password,
    age: payload.age as Number,
    gender: payload.gender as String default null
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <java:invoke-static method="hashPassword(java.lang.String)" doc:name="Invoke static" doc:id="b2934ceb-a3f2-4a72-b6bd-9bdeb1ba37c8" class="security.PasswordHasher" target="hashedPassword">
            <java:args><![CDATA[#[arg0: payload.password]]]></java:args>
        </java:invoke-static>
        <try doc:name="Try" doc:id="9510a0ad-5b1e-4eed-a19c-84d407af9e09">
            <db:update doc:name="Update an existing user" doc:id="6d45d197-b16b-41d7-92b0-2f9326b35ea6" config-ref="Database_Config">
                <db:sql><![CDATA[UPDATE `ims`.`users`
SET
    `first_name` = :firstName,
    `last_name` = :lastName,
    `email` = :email,
    `password` = :password,
    `age` = :age,
    `gender` = :gender
WHERE `user_id` = :userId]]></db:sql>
                <db:input-parameters><![CDATA[#[{
	userId: vars.updateUserId,
	firstName: payload.firstName,
	lastName: payload.lastName,
	email: payload.email,
	password: vars.hashedPassword,
	age: payload.age,
	gender: payload.gender
}]]]></db:input-parameters>
            </db:update>
            <ee:transform doc:name="Transform Message" doc:id="8021c4a9-4552-4069-9979-d54a154fe414">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	message: "User successfully updated"
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </try>
        <remove-variable doc:name="Remove Variable" doc:id="fe0f1e88-c051-48fb-9118-7ab3170c6d76" variableName="updateUserId" />
        <logger level="INFO" doc:name="Logger" doc:id="b039030f-12c8-4bc2-8e4a-9e24b40ee4d5" message="Successfully updated user" />
    </flow>
    <flow name="delete:\users\(userId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="b18df9ff-fa45-4602-89d9-60052f1abf36" variableName="deleteUserId" />
        <try doc:name="Try" doc:id="fd4492cc-9aa9-4c91-b9db-6fc4e4898fa1">
            <db:delete doc:name="Delete an user" doc:id="098effcf-9125-4f6c-bc84-17b1741290a6" config-ref="Database_Config">
                <db:sql><![CDATA[DELETE FROM users WHERE user_id = :USER_ID]]></db:sql>
                <db:input-parameters><![CDATA[#[{USER_ID: vars.deleteUserId}]]]></db:input-parameters>
            </db:delete>
            <ee:transform doc:name="Transform Message" doc:id="c56e638d-03ad-459c-bfbf-14691f8419db">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	message: "User successfully deleted"
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </try>
        <remove-variable doc:name="Remove Variable" doc:id="56f93c4b-11db-4a3a-a952-ff668142e252" variableName="deleteUserId" />
        <logger level="INFO" doc:name="Logger" doc:id="f2473eb0-72ae-4dec-8e92-29641facb259" message="delete:\users\(userId):bachelorims-config" />
    </flow>
    <flow name="get:\items:ims_specs-config">
        <flow-ref doc:name="GetAllItems" doc:id="f91b3a01-fe61-42b3-92fd-16f00cc4c384" name="getAllItems" />
    </flow>
    <flow name="get:\items\(itemId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'itemId']" doc:name="Set Variable" doc:id="0605a2c4-4e31-46e6-b669-b8f5560cb12a" variableName="GetItemId" />
        <flow-ref doc:name="getSpecifikItem" doc:id="8632ce3b-ce94-4c2a-b903-bd8a08c68158" name="getSpecificItem" />
        <remove-variable doc:name="Remove Variable" doc:id="38e340bc-4fc6-42d0-87ae-b4989d950ff7" variableName="GetItemId" />
    </flow>
    <flow name="get:\items\(userId)\items:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="fe0366d4-2612-4ee3-8599-b62d917a51d1" variableName="userId" />
        <flow-ref doc:name="getAllItemUser" doc:id="a0c1d770-46f5-4de5-8391-b88c2ef056f9" name="getAllItemsForSpecificUser" />
        <remove-variable doc:name="Remove Variable" doc:id="3eb9906a-0985-4d41-9981-8ace48f667ec" variableName="userId" />
    </flow>
    <flow name="post:\items:application\json:ims_specs-config">
        <set-variable value="#[attributes.queryParams.'collectionId']" doc:name="Set Variable" doc:id="6557c649-ad76-49aa-9057-93553693a9d4" variableName="PostItem" />
        <ee:transform doc:name="Transform Message" doc:id="05ccc646-25e9-4197-87da-5b5507f891a7">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  name: payload.name,
  price: payload.price as Number,
  amount: payload.amount as Number,
  "type": payload."type",
  width: payload.width as Number,
  height: payload.height as Number,
  color: payload.color,
} as Object {encoding: "UTF-8", mediaType: "application/json"}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <flow-ref doc:name="createNewItem" doc:id="c6f5587f-6f08-43c5-ad05-9a42fceff882" name="createNewItem" />
        <remove-variable doc:name="Remove Variable" doc:id="a5c587dd-c465-423a-a1d6-1c26fc5960d9" variableName="PostItem" />
    </flow>
    <flow name="put:\items\(itemId):application\json:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'itemId']" doc:name="Set Variable" doc:id="324ea670-48a1-4195-85e9-f53e858e6666" variableName="updateItemId" />
        <ee:transform doc:name="Transform Message" doc:id="a2b67a33-8133-4bca-aec5-48e69173a6c8">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	name: payload.name,
	price: payload.price as Number,
	amount: payload.amount as Number,
	"type": payload."type",
	width: payload.width as Number,
	height: payload.height as Number,
	color: payload.color,
	collectionId: payload.collectionId as Number
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <flow-ref doc:name="updateItem" doc:id="771b5bed-2350-4c05-9333-1746c04c9e75" name="updateItem" />
        <remove-variable doc:name="Remove Variable" doc:id="d761e042-a40e-4012-a4ce-e750f627755e" variableName="updateItemId" />
    </flow>
    <flow name="delete:\items\(itemId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'itemId']" doc:name="Set Variable" doc:id="da8cf4b8-d069-431f-9744-8d4b6908e822" variableName="deleteItemId" />
        <flow-ref doc:name="deleteItem" doc:id="df397585-805b-40cc-8901-6d257ffc3497" name="deleteItem" />
        <remove-variable doc:name="Remove Variable" doc:id="60a6f99b-69df-4ce5-b446-9efd93fdf92d" variableName="deleteItemId" />
    </flow>
    <flow name="get:\collections:ims_specs-config">
        <db:select doc:name="Select all collections" doc:id="c06b6e67-f91d-4aab-9df6-edfe088707bf" config-ref="Database_Config">
            <db:sql><![CDATA[SELECT * FROM collections]]></db:sql>
        </db:select>
        <ee:transform doc:name="Transform Message" doc:id="e82bc418-b170-4ed2-89b1-eecf1d533c58">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	collectionId: payload01.collection_id,
	userId: payload01.user_id
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
    </flow>
    <flow name="get:\collections\(collectionId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'collectionId']" doc:name="Set Variable" doc:id="ceda5ca4-d6b7-4b01-bed4-ec239756da20" variableName="getSingleCollection" />
        <try doc:name="Try" doc:id="775f3be8-fb17-4ea4-8254-04622d7e9901">
            <db:query-single doc:name="Query single collection" doc:id="3251b474-866e-41be-ac13-042bafb1516e" config-ref="Database_Config">
                <db:sql><![CDATA[SELECT * FROM collections
WHERE collection_id = :CID]]></db:sql>
                <db:input-parameters><![CDATA[#[{CID: vars.getSingleCollection}]]]></db:input-parameters>
            </db:query-single>
            <ee:transform doc:name="Transform Message" doc:id="7139686f-8ef4-4db8-84bb-ba85abba5cec">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	collectionId: payload.collection_id,
	userId: payload.user_id
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
        </try>
        <remove-variable doc:name="Remove Variable" doc:id="28241db2-50e5-4943-b8e8-e11557058c4e" variableName="getSingleCollection" />
    </flow>
    <flow name="get:\collections\(collectionId)\items:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'collectionId']" doc:name="Set Variable" doc:id="dbcc03b0-f1ab-4f56-9e67-405ac4386094" variableName="getCollectionWithItems" />
        <flow-ref doc:name="Flow Reference" doc:id="d8d8ad70-83eb-4630-b6e2-bd25f5df655f" name="getSpecificCollectionWithItems" />
        <remove-variable doc:name="Remove Variable" doc:id="0a7c80c7-b037-44e4-b802-5791dc61cf64" variableName="getCollectionWithItems" />
    </flow>
    <flow name="post:\collections:application\json:ims_specs-config">
        <flow-ref doc:name="Flow Reference" doc:id="d19b124c-9952-4d6e-a974-06dba8e5386f" name="createNewCollection" />
    </flow>
    <flow name="delete:\collections\(collectionId):ims_specs-config">
        <set-variable value="#[attributes.uriParams.'collectionId']" doc:name="Set Variable" doc:id="008be2e2-7146-4fe3-9fa1-059b5d1a94e5" variableName="deleteCollectionId" />
        <flow-ref doc:name="Flow Reference" doc:id="ffa8e738-9766-402a-b43c-c5cf52ebe55b" name="deleteSpecificCollection" />
        <remove-variable doc:name="Remove Variable" doc:id="2c2a7ddf-1228-4dd2-87e3-65d26588c01a" variableName="deleteCollectionId" />
    </flow>
    <flow name="get:\users\(userId)\collections:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="f58ad909-3517-42b5-bf9b-b0a64a0897bc" variableName="userId" />
        <flow-ref doc:name="Flow Reference" doc:id="1094c200-1273-4ed0-9b72-fc2095559579" name="getAllCollectionForUser" />
        <remove-variable doc:name="Remove Variable" doc:id="117046b2-b19d-4186-807d-f04957d57139" variableName="userId" />
    </flow>
    <flow name="post:\auth\login:application\json:ims_specs-config">
        <set-variable value="#[{ password: payload.password as String, email: payload.email as String }]" doc:name="Set Variable" doc:id="ee6bfb5c-59de-46cf-afc7-008f170d18e2" variableName="pp" />
        <flow-ref doc:name="Auth/verifyUser" doc:id="78ed8acb-61f2-459b-bad0-f3c94dc17292" name="verifyUser" />
        <flow-ref doc:name="Auth/ createJwT" doc:id="2997c477-3428-4360-b99c-37a0dbefb4ed" name="createJwtToken" />
        <ee:transform doc:name="Transform Message" doc:id="60c45acd-c2f7-44ff-8338-d815c98bf812">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	token: vars.jwtToken,
	user: payload
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <logger level="INFO" doc:name="Logger" doc:id="1470ffe3-838c-4ac4-8e8d-c11184b43cb9" />
        <remove-variable doc:name="Remove Variable" doc:id="5614cd9d-b2a9-4111-8ca0-cce1354ac22c" variableName="pp" />
    </flow>
    <flow name="post:\auth\verify:application\json:ims_specs-config">
        <ee:transform doc:name="Transform Message" doc:id="de7f1df1-d56e-47c2-b78e-b2e7b8127744">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	token: payload.token
}]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <flow-ref doc:name="Flow Reference" doc:id="0bd66286-6da4-4ae6-88d8-3763e81709b3" name="validateJwtToken" />
        <ee:transform doc:name="Transform Message" doc:id="bf8a4213-410f-4354-ad3f-213cbdd774c4">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
            </ee:message>
        </ee:transform>
        <logger level="INFO" doc:name="Logger" doc:id="fc147d34-5165-4c6d-8aa6-5b328c0d2949" />
    </flow>
    <flow name="post:\users\(userId)\sendInvite:application\json:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="3926910a-5cb7-4ba5-addf-03218d608cd1" variableName="userId" />
		<flow-ref doc:name="Flow Reference" doc:id="0008cbb8-793e-47e3-89f4-029484bc5444" name="sendInvite" />
		<remove-variable doc:name="Remove Variable" doc:id="b15f6c8c-974c-4d6e-98da-e43e94107bad" variableName="userId" />
    </flow>
    <flow name="get:\users\(email)\invitations:ims_specs-config">
		<set-variable value="#[attributes.uriParams.'email']" doc:name="Set Variable" doc:id="6eeee4cc-ff89-48a2-bbcc-eecedf0bedb4" variableName="userEmail" />
		<flow-ref doc:name="Flow Reference" doc:id="40d4060b-3b44-43cd-9c78-ba2671e84e63" name="getUserInvites" />
		<remove-variable doc:name="Remove Variable" doc:id="4d386740-dc23-40ae-819a-638b952363bb" variableName="userEmail" />
    </flow>
    <flow name="put:\users\(userId)\acceptInvite:application\json:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="aea96777-a98a-447c-a751-8fddbbb099a9" variableName="userId" />
		<flow-ref doc:name="Flow Reference" doc:id="fc145084-1287-40d9-b525-03fe5070fa77" name="acceptInvite" />
		<remove-variable doc:name="Remove Variable" doc:id="7f0bc257-18f5-4823-b54f-6195588d1fea" variableName="userId" />
    </flow>
    <flow name="patch:\users\(userId)\denyInvite:application\json:ims_specs-config">
        <set-variable value="#[attributes.uriParams.'userId']" doc:name="Set Variable" doc:id="0468a34d-e157-4b11-9308-2e60245c4415" variableName="userId" />
		<flow-ref doc:name="Flow Reference" doc:id="c8c9485d-a324-4446-a9cf-0574bca0f5be" name="denyInvite" />
		<remove-variable doc:name="Remove Variable" doc:id="bf4f4c54-ca84-4c5b-9166-f15af73cc218" variableName="userId" />
    </flow>
</mule>
